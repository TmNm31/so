<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>버스 혼잡도 앱</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    .page { display: none; padding: 20px; }
    .active { display: block; }
    .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin: auto; max-width: 500px; }
    .button { background: #007BFF; color: white; padding: 10px; margin-top: 10px; border: none; border-radius: 5px; cursor: pointer; text-align: center; }
    .button:hover { background: #0056b3; }
    .seat-container { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; margin-top: 15px; }
    .seat { width: 100%; padding-top: 100%; position: relative; background-color: #ccc; border-radius: 5px; }
    .seat::after {
      content: attr(data-label);
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      color: white;
    }
  </style>
</head>
<body>

<!-- 페이지 1: 버스 번호 입력 -->
<div id="mainPage" class="page active">
  <div class="card">
    <h2>버스 번호 입력</h2>
    <input type="text" id="busNumberInput" placeholder="예: 131번" />
    <div class="button" onclick="nextToRouteSelection()">다음</div>
  </div>
</div>

<!-- 페이지 2: 출발지/도착지 선택 -->
<div id="routePage" class="page">
  <div class="card">
    <h2>출발지 / 도착지 선택</h2>
    <select id="startSelect"></select>
    <select id="endSelect"></select>
    <div class="button" onclick="nextToSeatView()">혼잡도 보기</div>
    <div class="button" onclick="showPage('mainPage')">← 뒤로가기</div>
  </div>
</div>

<!-- 페이지 3: 좌석 표시 (일반) -->
<div id="seatPage" class="page">
  <div class="card">
    <h3>버스 좌석 및 혼잡도</h3>
    <div id="busInfo"></div>
    <div id="seatContainer" class="seat-container"></div>
    <div class="button" onclick="showPage('cameraPage')">카메라로 혼잡도 확인</div>
    <div class="button" onclick="showPage('routePage')">← 뒤로가기</div>
  </div>
</div>

<!-- 페이지 4: 카메라 혼잡도 -->
<div id="cameraPage" class="page">
  <div class="card">
    <h3>카메라로 혼잡도 측정</h3>
    <video id="video" autoplay playsinline width="100%" style="max-height: 200px;"></video>
    <div id="cameraCongestionLevel" style="margin-top: 10px;"></div>
    <div id="cameraSeatContainer" class="seat-container"></div>
    <div class="button" onclick="detectPeople()">혼잡도 측정 시작</div>
    <div class="button" onclick="showPage('seatPage')">← 좌석 보기로 돌아가기</div>
  </div>
</div>

<script>
  let currentPassengerCount = 0;

  const routes = {
    "1": ["반성터미널", "시정", "진주외국어고등학교/반성시장"],
    "2": ["반성터미널", "수목원", "진주외국어고등학교"],
    "3": ["반성터미널", "반성중학교", "다무"],
    "131": ["진양호차고지", "평거초등학교", "경해여자고등학교"],
    "904": ["진주시외터미널", "진주역", "사천공항"]
  };

  function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (id === 'seatPage') {
      renderSeats(currentPassengerCount, 'seatContainer');
    }
  }

  function nextToRouteSelection() {
    const busNum = document.getElementById('busNumberInput').value.trim();
    if (!routes[busNum]) {
      alert("해당 버스 번호의 노선 정보가 없습니다.");
      return;
    }
    const startSel = document.getElementById('startSelect');
    const endSel = document.getElementById('endSelect');
    startSel.innerHTML = '';
    endSel.innerHTML = '';
    routes[busNum].forEach(stop => {
      startSel.innerHTML += `<option value="${stop}">${stop}</option>`;
      endSel.innerHTML += `<option value="${stop}">${stop}</option>`;
    });
    showPage('routePage');
  }

  function nextToSeatView() {
    const start = document.getElementById('startSelect').value;
    const end = document.getElementById('endSelect').value;
    document.getElementById('busInfo').innerText = `출발: ${start}, 도착: ${end}\n예상 도착: 3정거장 후`;
    showPage('seatPage');
  }

  function rand(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function renderSeats(count = 0, containerId = 'seatContainer') {
    const seatContainer = document.getElementById(containerId);
    seatContainer.innerHTML = '';
    for (let i = 0; i < 20; i++) {
      const seat = document.createElement('div');
      seat.className = 'seat';
      seat.dataset.label = i < count ? '■' : '□';
      seat.style.backgroundColor = i < count ? '#28a745' : '#ccc';
      seatContainer.appendChild(seat);
    }
  }

  function isRunningStandalone() {
    return (window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone === true;
  }

  function detectPeople() {
    if (!isRunningStandalone()) {
      alert("이 기능은 앱 설치 후 실행했을 때만 사용할 수 있습니다.");
      return;
    }

    navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' } },
      audio: false
    }).then(stream => {
      const video = document.getElementById('video');
      video.srcObject = stream;
    }).catch(err => {
      alert("카메라 접근 실패: " + err.message);
    });

    const levels = ['쾌적', '보통', '혼잡'];
    let index = 0;
    setInterval(() => {
      const level = levels[index % levels.length];
      const color = level === '쾌적' ? 'green' : level === '보통' ? 'orange' : 'red';
      const div = document.getElementById('cameraCongestionLevel');
      div.textContent = `혼잡도: ${level}`;
      div.style.color = color;

      currentPassengerCount = level === '쾌적' ? rand(1, 4) :
                              level === '보통' ? rand(5, 13) :
                              rand(14, 20);

      renderSeats(currentPassengerCount, 'cameraSeatContainer'); // 카메라 페이지
      renderSeats(currentPassengerCount, 'seatContainer');       // 일반 좌석 페이지

      index++;
    }, 10000);
  }
</script>
</body>
</html>
